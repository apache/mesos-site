<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Apache Mesos - Containerizer Internals</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta property="og:locale" content="en_US"/>
    <meta property="og:type" content="website"/>
    <meta property="og:title" content="Apache Mesos"/>
    <meta property="og:site_name" content="Apache Mesos"/>
    <meta property="og:url" content="https://mesos.apache.org/"/>
    <meta property="og:image" content="https://mesos.apache.org/assets/img/mesos_logo_fb_preview.png"/>
    <meta property="og:description"
          content="Apache Mesos abstracts resources away from machines,
                   enabling fault-tolerant and elastic distributed systems
                   to easily be built and run effectively."/>

    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@ApacheMesos"/>
    <meta name="twitter:title" content="Apache Mesos"/>
    <meta name="twitter:image" content="https://mesos.apache.org/assets/img/mesos_logo_fb_preview.png"/>
    <meta name="twitter:description"
          content="Apache Mesos abstracts resources away from machines,
                   enabling fault-tolerant and elastic distributed systems
                   to easily be built and run effectively."/>

    <link href="../../../assets/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="alternate" type="application/atom+xml" title="Apache Mesos Blog" href="/blog/feed.xml">
    <link href="../../../assets/css/main.css" rel="stylesheet" />


  </head>
  <body>
    <!-- magical breadcrumbs -->
    <div class="topnav">
      <div class="container">
        <ul class="breadcrumb">
          <li>
            <div class="dropdown">
              <a data-toggle="dropdown" href="#">Apache Software Foundation <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                <li><a href="https://www.apache.org">Apache Homepage</a></li>
                <li><a href="https://www.apache.org/licenses/">License</a></li>
                <li><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                <li><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                <li><a href="https://www.apache.org/security/">Security</a></li>
              </ul>
            </div>
          </li>

          <li><a href="https://mesos.apache.org">Apache Mesos</a></li>
          <li><a href="/documentation/">Documentation</a></li>
        </ul><!-- /.breadcrumb -->
      </div><!-- /.container -->
    </div><!-- /.topnav -->

    <!-- navbar excitement -->
<div class="navbar navbar-default navbar-static-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#mesos-menu" aria-expanded="false">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/"><img src="/assets/img/mesos_logo.png" alt="Apache Mesos logo"/></a>
    </div><!-- /.navbar-header -->

    <div class="navbar-collapse collapse" id="mesos-menu">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/getting-started/">Getting Started</a></li>
        <li><a href="/blog/">Blog</a></li>
        <li><a href="/documentation/latest/">Documentation</a></li>
        <li><a href="/downloads/">Downloads</a></li>
        <li><a href="/community/">Community</a></li>
      </ul>
    </div><!-- /#mesos-menu -->
  </div><!-- /.container -->
</div><!-- /.navbar -->

<div class="content">
  <div class="container">
    <div class="row-fluid">
  <div class="col-md-4">
    <h4>If you're new to Mesos</h4>
    <p>See the <a href="/getting-started/">getting started</a> page for more
       information about downloading, building, and deploying Mesos.</p>

    <h4>If you'd like to get involved or you're looking for support</h4>
    <p>See our <a href="/community/">community</a> page for more details.</p>
  </div>
  <div class="col-md-8">
    <h1>Containerizer</h1>

<p>Containerizers are Mesos components responsible for launching
containers. They own the containers launched for the tasks/executors,
and are responsible for their isolation, resource management, and
events (e.g., statistics).</p>

<h1>Containerizer internals</h1>

<h3>Containerizer creation and launch</h3>

<ul>
<li>Agent creates a containerizer based on the flags (using agent flag
<code>--containerizers</code>). If multiple containerizers (e.g., docker,
mesos) are specified using the <code>--containerizers</code> flag, then the
composing containerizer will be used to create a containerizer.</li>
<li>If an executor is not specified in <code>TaskInfo</code>, Mesos agent will use
the default executor for the task (depending on the Containerizer
the agent is using, it could be <code>mesos-executor</code> or
<code>mesos-docker-executor</code>). TODO: Update this after MESOS-1718 is
completed. After this change, master will be responsible for
generating executor information.</li>
</ul>


<h3>Types of containerizers</h3>

<p>Mesos currently supports the following containerizers:</p>

<ul>
<li>Composing</li>
<li><a href="/documentation/latest/./docker-containerizer/">Docker</a></li>
<li><a href="/documentation/latest/./mesos-containerizer/">Mesos</a></li>
</ul>


<h4>Composing Containerizer</h4>

<p>Composing containerizer will compose the specified containerizers
(using agent flag <code>--containerizers</code>) and act like a single
containerizer. This is an implementation of the <code>composite</code> design
pattern.</p>

<h4>Docker Containerizer</h4>

<p>Docker containerizer manages containers using the docker engine provided
in the docker package.</p>

<h5>Container launch</h5>

<ul>
<li>Docker containerizer will attempt to launch the task in docker only
if <code>ContainerInfo::type</code> is set to DOCKER.</li>
<li>Docker containerizer will first pull the image.</li>
<li>Calls pre-launch hook.</li>
<li>The executor will be launched in one of the two ways:</li>
</ul>


<p>A) Mesos agent runs in a docker container</p>

<ul>
<li>This is indicated by the presence of agent flag
<code>--docker_mesos_image</code>. In this case, the value of flag
<code>--docker_mesos_image</code> is assumed to be the docker image used to
launch the Mesos agent.</li>
<li>If the task includes an executor (custom executor), then that executor is
launched in a docker container.</li>
<li>If the task does not include an executor i.e. it defines a command, the
default executor <code>mesos-docker-executor</code> is launched in a docker container to
execute the command via Docker CLI.</li>
</ul>


<p>B) Mesos agent does not run in a docker container</p>

<ul>
<li>If the task includes an executor (custom executor), then that executor is
launched in a docker container.</li>
<li>If task does not include an executor i.e. it defines a command, a subprocess
is forked to execute the default executor <code>mesos-docker-executor</code>.
<code>mesos-docker-executor</code> then spawns a shell to execute the command via Docker
CLI.</li>
</ul>


<h4>Mesos Containerizer</h4>

<p>Mesos containerizer is the native Mesos containerizer. Mesos
Containerizer will handle any executor/task that does not specify
<code>ContainerInfo::DockerInfo</code>.</p>

<h5>Container launch</h5>

<ul>
<li>Calls prepare on each isolator.</li>
<li>Forks the executor using Launcher (see <a href="#Launcher">Launcher</a>). The
forked child is blocked from executing until it is been isolated.</li>
<li>Isolate the executor. Call isolate with the pid for each isolator
(see <a href="#Isolators">Isolators</a>).</li>
<li>Fetch the executor.</li>
<li>Exec the executor. The forked child is signalled to continue. It
will first execute any preparation commands from isolators and then
exec the executor.</li>
</ul>


<p><a name="Launcher"></a></p>

<h5>Launcher</h5>

<p>Launcher is responsible for forking/destroying containers.</p>

<ul>
<li>Forks a new process in the containerized context. The child will
exec the binary at the given path with the given argv, flags, and
environment.</li>
<li>The I/O of the child will be redirected according to the specified
I/O descriptors.</li>
</ul>


<h6>Linux launcher</h6>

<ul>
<li>Creates a &ldquo;freezer&rdquo; cgroup for the container.</li>
<li>Creates posix &ldquo;pipe&rdquo; to enable communication between host (parent
process) and container process.</li>
<li>Spawn child process (container process) using <code>clone</code> system call.</li>
<li>Moves the new container process to the freezer hierarchy.</li>
<li>Signals the child process to continue (exec'ing) by writing a
character to the write end of the pipe in the parent process.</li>
</ul>


<p>Starting from Mesos 1.1.0, <a href="/documentation/latest/./nested-container-and-task-group/">nested container</a>
is supported. The Linux Launcher is responsible to fork the subprocess
for the nested container with appropriate Linux namespaces being
cloned. The following is the table for Linux namespaces that
are supported for top level and nested containers.</p>

<h6>Linux Namespaces</h6>

<table class="table table-striped">
  <tr>
    <th>Linux Namespaces</th>
    <th>Top Level Container</th>
    <th>Nested Container</th>
  </tr>
  <tr>
    <td>Mount</td>
    <td>Not shared</td>
    <td>Not shared</td>
  </tr>
  <tr>
    <td>PID</td>
    <td>Configurable</td>
    <td>Configurable</td>
  </tr>
  <tr>
    <td>Network & UTS</td>
    <td>Configurable</td>
    <td>Shared w/ parent</td>
  </tr>
  <tr>
    <td>IPC</td>
    <td>Not shared -> configurable (TBD)</td>
    <td>Not shared -> configurable (TBD)</td>
  </tr>
  <tr>
    <td>Cgroup</td>
    <td>Shared w/ agent -> Not shared (TBD)</td>
    <td>Shared w/ parent -> Not shared (TBD)</td>
  </tr>
  <tr>
    <td>User (not supported)</td>
    <td>Shared w/ agent</td>
    <td>Shared w/ parent</td>
  </tr>
</table>


<p>*Note: For the top level container, <code>shared</code> means that the container
shares the namespace from the agent. For the nested container, <code>shared</code>
means that the nested container shares the namespace from its parent
container.</p>

<h6>Posix launcher (TBD)</h6>

<p><a name="Isolators"></a></p>

<h5><a href="/documentation/latest/./mesos-containerizer/#isolators">Isolators</a></h5>

<p><a href="/documentation/latest/./mesos-containerizer/#isolators">Isolators</a> are responsible for creating
an environment for the containers where resources like cpu, network,
storage and memory can be isolated from other containers.</p>

<h3>Containerizer states</h3>

<h4>Docker</h4>

<ul>
<li>FETCHING</li>
<li>PULLING</li>
<li>RUNNING</li>
<li>DESTROYING</li>
</ul>


<h4>Mesos</h4>

<ul>
<li>PREPARING</li>
<li>ISOLATING</li>
<li>FETCHING</li>
<li>RUNNING</li>
<li>DESTROYING</li>
</ul>


  </div>
</div>

  </div><!-- /.container -->
</div><!-- /.content -->

<hr>



    <!-- footer -->
    <div class="footer">
      <div class="container">

        <div class="col-md-12 trademark">
          <p>&copy; 2012-2022 <a href="https://apache.org">The Apache Software Foundation</a>.
            Apache Mesos, the Apache feather logo, and the Apache Mesos project logo are trademarks of The Apache Software Foundation.
          <p>
        </div>

      </div><!-- /.container -->
    </div><!-- /.footer -->

    <!-- JS -->
    <script src="../../../assets/js/jquery-1.11.0.min.js"></script>
    <script src="../../../assets/js/bootstrap.min.js"></script>
    <script src="../../../assets/js/anchor-4.1.0.min.js"></script>

    <!-- Inject anchors for all headings on the page, see https://www.bryanbraun.com/anchorjs. -->
    <script type="text/javascript">
    anchors.options = {
      placement: 'right',
      ariaLabel: 'Permalink',
    };

    // The default is to not add anchors to h1, but we have pages with multiple h1 headers,
    // and we do want to put anchors on those.
    anchors.add('h1, h2, h3, h4, h5, h6');
    </script>
  </body>
</html>
